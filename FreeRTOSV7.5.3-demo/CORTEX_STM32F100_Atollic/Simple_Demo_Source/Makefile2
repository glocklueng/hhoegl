
# <Hubert.Hoegl@hs-augsburg.de>
# 2013-12-12

# This makefile can be used to compile the FreeRTOS demo against
# the original STM32 Std.-Periph Lib.

# Please adjust this path!
ROOTDIR = /home/hhoegl/STM32F10x_StdPeriph_Lib_V3.5.0

# I use gcc-arm-embedded from launchpad.net
CC=arm-none-eabi-gcc
LD=arm-none-eabi-ld
AR=arm-none-eabi-ar
AS=arm-none-eabi-as

ASFLAGS=-g

# STM32vldiscovery.[ch]
STM32UTIL = ../Utilities/STM32_EVAL/STM32_Discovery/

FRHOME = ../..
FREERTOSSRC = $(FRHOME)/Source:$(FRHOME)/Source/portable/GCC/ARM_CM3/:$(FRHOME)/Source/portable/MemMang/

VPATH = $(LIBSRCDIR):$(STM32UTIL):$(FREERTOSSRC)


# startup file fuer gcc in das aktuelle Verzeichnis kopiert
# STARTUP = $(ROOTDIR)/Libraries/CMSIS/CM3/DeviceSupport/ST/STM32F10x/startup/gcc_ride7/startup_stm32f10x_md_vl.s
STARTUP = startup_stm32f10x_md_vl.s

LIBSRCDIR = $(ROOTDIR)/Libraries/STM32F10x_StdPeriph_Driver/src
LIBINCDIR = $(ROOTDIR)/Libraries/STM32F10x_StdPeriph_Driver/inc

FREERTOS = /home/hhoegl/FreeRTOSV7.5.3/Source

FREERTOSINC = $(FREERTOS)/include/
# portmacro.h
FREERTOSPM = $(FREERTOS)/portable/GCC/ARM_CM3
# STM32vldiscovery.h
FREERTOSVL = ../Utilities/STM32_EVAL/STM32_Discovery

CMSISSRC = $(ROOTDIR)/Libraries/CMSIS/CM3/DeviceSupport/ST/STM32F10x/
CMSISCORE = $(ROOTDIR)/Libraries/CMSIS/CM3/CoreSupport/

ASSRC = startup_stm32f10x_md_vl.s
ASOBJ = $(ASSRC:.s=.o)

FRTOSSRC = croutine.c tasks.c list.c queue.c timers.c port.c heap_1.c
SRCS = main.c system_stm32f10x.c  STM32vldiscovery.c $(FRTOSSRC)
OBJS = $(SRCS:.c=.o) $(ASOBJ)
# stm32f10x_it.c 

CFLAGS = -g -O1 -c -fno-common -mcpu=cortex-m3 -mthumb -DSTM32F10X_MD_VL=1 -DUSE_STDPERIPH_DRIVER=1 -I$(LIBINCDIR) -I$(CMSISSRC) -I$(CMSISCORE) -I$(FREERTOSINC) -I$(FREERTOSPM) -I$(FREERTOSVL) -I.

all: main

main: $(OBJS)
	$(CC) -o main $(OBJS) -Tstm32f100.ld -L. -lst

%.o: %.c
	$(CC) $(CFLAGS) -c $<

%.o: %.s
	$(AS) $(ASFLAGS) -o $@ $<
	
clean:
	rm -f main *.o *~
